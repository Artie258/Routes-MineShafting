<script>
  // === keep your existing DATA here exactly as it is ===
  // const DATA = [ { key:'jas', title:'Jasper', text:`...full JSON...` }, ... ];

  // Make a short, compact preview from the full text
  function makePreview(full, maxLen = 260) {
    if (!full) return '';
    // Collapse whitespace/newlines to single spaces for display
    const compact = full.replace(/\s+/g, ' ').trim();
    return compact.length > maxLen ? compact.slice(0, maxLen) + ' â€¦' : compact;
  }

  const grid = document.getElementById('grid');
  grid.innerHTML = DATA.map((row, i) => {
    const preview = makePreview(row.text);
    // quick line count for the gutter (preview only)
    const lines = (preview.match(/\n/g) || []).length + 1;
    const ln = Array.from({ length: lines }, (_, n) => `<div>${n + 1}</div>`).join('');
    return `
      <section class="card">
        <div class="titleRow" style="display:flex;align-items:center;gap:10px">
          <img id="icon${i}" alt="${row.title} icon" style="width:28px;height:28px;image-rendering:pixelated;object-fit:contain;background:#0b1220;border-radius:8px;border:1px solid rgba(255,255,255,.08)" />
          <span class="title" style="font-size:1.4rem;font-weight:800">${row.title}</span>
        </div>

        <!-- compact, scrollable preview -->
        <div class="codewrap" style="position:relative;border:1px solid #213148;background:#0b1220;border-radius:12px;overflow:hidden">
          <div id="code${i}" class="code" style="display:grid;grid-template-columns:auto 1fr;gap:0;max-height:180px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.86rem;line-height:1.4;color:#cfd6e4">
            <div class="gutter" style="background:#0f1a2a;border-right:1px solid #1e2b41;color:#7f8b9b;padding:10px 8px;user-select:none">${ln}</div>
            <pre id="pre${i}" style="margin:0;padding:10px 12px;white-space:pre-wrap;word-break:break-word">${preview}</pre>
          </div>
        </div>

        <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="copy" data-copy="${i}">Copy</button>
          <button class="ghost" data-dl="${i}" style="background:#1b283a;border:1px solid #26405e;color:#d7e3f4;border-radius:10px;padding:8px 10px;cursor:pointer">Download .json</button>
        </div>
      </section>
    `;
  }).join('');

  // load icons
  const exts = ['png','webp','jpg','jpeg'];
  DATA.forEach((row, i) => {
    const img = document.getElementById('icon' + i);
    const base = 'images/gem.' + row.key;
    let j = 0;
    (function next() {
      if (j >= exts.length) { img.style.display = 'none'; return; }
      img.onerror = () => { j++; next(); };
      img.src = base + '.' + exts[j];
    })();
  });

  // copy full text (not the compact preview)
  document.querySelectorAll('[data-copy]').forEach(btn => {
    btn.addEventListener('click', () => {
      const i = +btn.dataset.copy;
      copyToClipboard(DATA[i].text);  // full block
    });
  });

  // download full text as .json
  document.querySelectorAll('[data-dl]').forEach(btn => {
    btn.addEventListener('click', () => {
      const i = +btn.dataset.dl;
      const blob = new Blob([DATA[i].text], { type: 'application/json;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = DATA[i].title.replace(/\s+/g, '_') + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  });

  // Copy All = full blocks joined
  document.getElementById('copyAll')?.addEventListener('click', () => {
    const all = DATA.map(r => r.text).join('\n\n');
    copyToClipboard(all);
  });

  async function copyToClipboard(text) {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
      toast('Copied!');
    } catch {
      toast('Copy failed');
    }
  }

  // tiny toast
  const t = document.getElementById('toast') || (() => {
    const el = document.createElement('div');
    el.id = 'toast';
    el.style.cssText = 'position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(2,6,23,.95);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;color:#e5e7eb;opacity:0;transition:opacity .25s ease;z-index:9999';
    document.body.appendChild(el);
    return el;
  })();
  let timer;
  function toast(msg) {
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(timer);
    timer = setTimeout(() => t.style.opacity = '0', 1200);
  }
</script>
